---
title: "Gráficos Poblacional y Temperatura"
output:
  html_document:
    css: tutorial.css
    fig_caption: yes
    highlight: pygments
    theme: simplex
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Fecha de la ultima revisión
```{r echo=FALSE}

Sys.Date()
```

```{r, eval=TRUE, echo=FALSE}
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}

#`r colorize("some words in red", "red")`
```

```{r, echo=FALSE, fig.show = "hold", out.width = "20%", fig.align = "default"}
knitr::include_graphics(c("Graficos/hex_ggversa.png", "Graficos/hex_Visualizacion_Datos.png"))
```

```{r}

#devtools::install_github("EvaMaeRey/flipbookr")

library(tidyverse)
library(ggversa)
library(janitor)
library(gridExtra) # paquete para organizar los gráficos

```


***

# Pirámides poblacionales con **geom_bar**


Un ejemplo interesante de **geom_bar** es cuando creamos pirámides poblacionales. Para el próximo ejemplo utilizaremos datos del censo de la base de datos de la Oficina del Censo de los EE. UU. **US Census** del 2015 sobre la población de Puerto Rico.  Los datos representan la cantidad de mujeres en `r colorize("azul", "blue")` y hombres en `r colorize("rojo", "red")` en categorías de edad; o sea, de 0 a 4 años, de 5 a 9 años y así sucesivamente.  La última categoría incluye todos los puertorriqueños de 85 años o más.  Para producir este gráfico, se generarán dos **geom_bar** uno al lado del otro; uno con los datos de **Mujer** (derecha) y otro con los datos de **Hombre** (izquierda).

Para especificar que se usen solamente los datos de un subgrupo de cada variable, se hace de la misma manera que en R; o sea, 

    subset(Pop_PR,Pop_PR$Sexo=="Mujer") # el "==" es para indicar que tiene que cumplir con esta condición exclusiva


También note que tenemos datos a la izquierda y a la derecha del valor de cero. Se produce este patrón usando {-Valor} en uno de los grupos, donde el valor es el tamaño poblacional por grupo de edad.  Por último, se tiene que añadir **coord_flip()** para que las barras queden de forma horizontal.

```{r geom_barraDemo,  echo=TRUE}
ggversa::Pop_PR
# Para observar las primeras 4 filas del archivo
head(Pop_PR, n=5)

# Para observar las ultimas 4 filas del archivo
tail(Pop_PR, n=4)

ggplot(data=Pop_PR) +
  geom_bar(aes(Edad, Valor, group= Sexo, fill=Sexo),
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Mujer"))



ggplot(data=Pop_PR) +
  geom_bar(aes(Edad,-Valor,group=Sexo,fill=Sexo),  # nota el "negativo" antes de la 
           #variable "Valor", se le esta asignando un valor negativo a cada valor a los hombres.  
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Hombre"))
```


# Unir los dos graficos de barras

```{r}
ggplot(data=Pop_PR) +
  geom_bar(aes(Edad, Valor, group= Sexo, fill=Sexo),
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Mujer"))+
  geom_bar(aes(Edad,-Valor,group=Sexo,fill=Sexo),  # nota el "negativo" antes de la 
           #variable "Valor", se le esta asignando un valor negativo a cada valor a los hombres.  
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Hombre"))

```


```{r}
ggplot(data=Pop_PR) +
  geom_bar(aes(Edad, Valor, group= Sexo, fill=Sexo),
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Mujer"))+
  geom_bar(aes(Edad,-Valor,group=Sexo,fill=Sexo),  # nota el "negativo" antes de la 
           #variable "Valor", se le esta asignando un valor negativo a cada valor a los hombres.  
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Hombre"))+
  scale_y_continuous(breaks=seq(-140000,140000,40000),
                     labels=abs(seq(-140000,140000,40000)))+
  coord_flip()+
  ylab("Tamaño poblacional")+
  theme(axis.title=element_text(size=10,face="bold"))+
  scale_fill_manual(values = c("green", "#36211D"))+
  scale_color_manual(values = c("green", "#36211D"))


#Population Pyramid de PR, del censo 2015. 

# ggsave("Graficos/Piramide_PR_censo2015.png")

Pop_PR$SexoNum=as.numeric(Pop_PR$Sexo)
head(Pop_PR)
```

***

Si no se le añade coord_flip(), el gráfico quedará representado con las barras de forma vertical (o en columnas).

```{r geom-barraDemo2,  echo=TRUE}
unique(Pop_PR$Sexo)
ggplot(data=Pop_PR) +
  geom_bar(aes(Edad,Valor,group=Sexo,fill=Sexo),
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Mujer"))+
  geom_bar(aes(Edad,-Valor,group=Sexo,fill=Sexo),
           stat = "identity",
           subset(Pop_PR,Pop_PR$Sexo=="Hombre")) +
  scale_y_continuous(breaks=seq(-140000,140000,40000),
                     labels=abs(seq(-140000,140000,40000))) +
  ylab("Tamaño poblacional")+
  theme(axis.title=element_text(size=10,face="bold"))



```


## TAREA: 

2. Seleccione el archivo "DominicanRepublic,csv" que se encuentra en la pestaña "Los datos".  Estos datos provienen las naciones unidas del siguiente enlace [PoblacionEdad_genero](http://data.un.org/Data.aspx?d=POP&f=tableCode%3A22), los datos fueron pre-selecionado a incluir solamente los datos la isla de la Republica Dominicana y no todos los países del mundo.  Seleccione la variable solamente el país de "Dominican Republican", mujeres y hombres, para el año de 2010, y el área solamente la población del campo. Que representa la cantidad de personas con esta edad en el muestreo censal del año 2013. 
  
    -- paso 1
    
      subir los datos
      
    -- paso 2
    
      seleccionar las columnas y variables de interes
      
    --  paso 3
    
    Producir una piramide de la poblacion de la Republica Dominicana
  


     -- Mire el nombre de las columnas primero y como esta organiado
     - Cambie de color las barras
     - Cambie el nombre de los nombres de los ejes
     - Salva el gráfico con extensión de .png
     - Sube el gráfico a Edmodo
     
     
     




```{r, eval=FALSE, echo=FALSE}
library(readr)
DominicanRepublic <- read_csv("Data/DominicanRepublic.csv")

head(DominicanRepublic)
unique(DominicanRepublic$Area)
DR=DominicanRepublic%>% 
  select(Year, Age, Sex, Area, Value) %>% 
  filter(Year==2010)%>% 
  filter(Area=="Urban") %>% 
filter(Sex %in% c("Female", "Male"))




unique(DR$AgeN)

#as.numeric(as.character(data_frame$column))
DR$AgeN=as.numeric(as.character(DR$Age))
head(DR)
DR$AgeN
ggplot(data=DR)+
  geom_bar(aes(AgeN,Value,group=Sex,fill=Sex),
           stat = "identity",
           subset(DR,DR$Sex=="Female"))+
  geom_bar(aes(AgeN,-Value,group=Sex,fill=Sex),
           stat = "identity",
           subset(DR,DR$Sex=="Male")) +
  ylab("Tamaño poblacional")+
  theme(axis.title=element_text(size=10,face="bold"))+
  coord_flip()

#ggsave("Graficos/Piramide_DR_censo2013.png")
DR %>% 
  arrange(desc(AgeN))
```


***

## Patrones de temperatura en tiempo con **geom_bar**

Este tipo de representación puede ser efectiva para mostrar patrones en donde los valores son negativos y positivos; por ejemplo, la temperatura. Para demostrarlo, ahora daremos un ejemplo que proviene del pueblo de Asbestos, Quebec, Canadá.  Los datos fueron extraídos de la base de datos de http://climate.weather.gc.ca/historical_data/search_historic_data_e.html (identifier 7020360).  El archivo de datos contiene la temperatura promedio (por mes) de la máxima y la mínima del 1948 al 1987.  Seleccionaremos solamente un conjunto limitado de los datos del año 1963 al 1968. Además, tendremos que voltear la información alrededor del eje de **X** para que se pueda leer, tal como se demuestra en la Figura. El primer paso es identificar que la variable Fecha es de tipo dato secuencial fecha y tiempo.  El segundo paso es identificar si los valores de temperatura máxima están por debajo o por encima del punto de congelación, < 0C°, o > 0C°, creando una nueva columna que aquí llamamos **NegPos**.  El tercer paso es usar solamente un subgrupo de información del archivo para mejorar la representación, ya que este tiene datos del 1948 al 1987.  Se seleccionan los años 1963 al 1966.

### Primero miramos los datos
```{r geom_Temperatura,  echo=TRUE}
library(ggversa)
names(ASBESTOS_QUEBEC)
head(ASBESTOS_QUEBEC)
is.data.frame(ASBESTOS_QUEBEC) # para determinar si el archivo es un data frame?
#ggversa::ASBESTOS_QUEBEC


```




```{r}


library(janitor)

ASBESTOS_QUEBEC=clean_names(ASBESTOS_QUEBEC)
head(ASBESTOS_QUEBEC)

```


### Identificar que la variable "Fecha" es una variable de tiempo. Habrá un modulo para discutir solamente de fechas y horas.  
```{r}
# Identificar que la variable "Fecha" es una variable de tiempo.
#names(ASBESTOS_QUEBEC)[names(ASBESTOS_QUEBEC) == 'Date.Time'] <- 'Fecha'

library(lubridate)
ASBESTOS_QUEBEC$date=ym(ASBESTOS_QUEBEC$fecha)
head(ASBESTOS_QUEBEC, n=4)


```

### Crear la nueva variable Temp_Prom_Max; 

Aquí se crea una nueva columna con para identificar si los datos son positivos o negativos, si es positiva = "TRUE", si es negativa = "FALSE". 

Identificar si las temperatura es por debajo o por encima de 0 celcius

```{r}
ASBESTOS_QUEBEC$negpos  =  ASBESTOS_QUEBEC$temp_prom_max>=0 # identificar que si una teperatura es debajo zero o no

head(ASBESTOS_QUEBEC)

```

### Selecionar solamente un subgrupo de los datos  
```{r}
library(tidyverse)

#ggplot(data=ASBESTOS_QUEBEC)+
 # aes(x=Fecha, y=temp_prom_max) +
  #geom_bar(stat = "identity", position="identity")


ASBESTOSsub=subset(ASBESTOS_QUEBEC, year>1962 & year<1967) # 1963 al 1966

head(ASBESTOSsub)
```

### Uniendo las partes para crear el gráfico


```{r}

ggplot(data=ASBESTOSsub,
  aes(x=fecha, y=temp_prom_max, fill=negpos)) +
  geom_bar(stat = "identity", position="identity")+
  theme(axis.text.x=element_text(angle=90))+
  guides(fill=FALSE)+
  xlab("Fecha")+
  ylab("Temperatura promedio \n máxima por mes en C°")+
  theme(axis.title=element_text(size=10,face="bold"))

```

## Tarea #2


2. Usando los datos de Anchorage, Alaska que se encuentra en la sección de datos aqui [Anchorage_Data](Data/Anchorage_ALASKA.csv), evaluar el patrón de temperatura mínima en los diferentes meses del año.  Convertir los datos de Farenheit a Celcius.  



```{r}
library(readr)
library(gt)
Anchorage_ALASKA <- read_csv("Data/Anchorage_ALASKA.csv")
gt(head(Anchorage_ALASKA))

```

```{r}
# gather the data in columns
# Paso 1
AA<-gather(Anchorage_ALASKA,
         key= "Mes",
         value="Temp_min_F", 
         -Year)
head(AA)      
```


```{r}
# Identificar que el Año y Mes son variables de tiempo

#Paso 2

numMonth<-function(x) 
c(jan=1,feb=2,mar=3,apr=4,may=5,jun=6,jul=7,aug=8,sep=9,oct=10,nov=11,dec=12)[tolower(x)]

AA$Fecha=numMonth(AA$Mes)
tail(AA)

#Paso 3

library(zoo)
AA$FechasMA <- as.yearmon(paste(AA$Year, AA$Fecha), "%Y %m")
head(AA)
```

## Conversión de temperatura

Cual el punto de congelación en Farenheit?

Como se convierte F° en C° 


```{r}
# Paso 4
AA$NegPos=AA$Temp_min_F>=32
head(AA)

AA$Temp_C=(AA$Temp_min_F-32)*5/9
head(AA)

AA$NegPosC=AA$Temp_C>=0
```


```{r}

ggplot(data=AA,
  aes(x=FechasMA, y=Temp_C, fill=NegPosC)) +
  geom_bar(stat = "identity", position="identity")+
  theme(axis.text.x=element_text(angle=90))+
  guides(fill=FALSE)+
  xlab("Fecha")+
  ylab("Temperatura promedio máxima por mes en Celsius")+
  theme(axis.title=element_text(size=10,face="bold"))

```



***

## Gráfico de barras: Ajuste de posiciones con **geom_bar**

  A veces queremos hacer que las barras luzcan de diferentes maneras; por ejemplo, que las posiciones de las barras no salgan verticales o tan gruesas. Además, se puede modificar la representación de las barras para que la altura de ellas no represente el número de observaciones; por ejemplo, que represente una suma sobre otra variable.

Los datos que utilizaremos para la próxima demostración provienen del archivo de lagartos **Anolis** que contiene información sobre su edad, sexo, periodo de muestreo y localidad donde fueron muestreados.

```{r importAnolis,   echo=TRUE}
library(ggversa)
names(Anolis)
```

El primer gráfico a continuación, produce por omisión barras negras que representan la suma de la cantidad de observaciones. 

```{r geombar2, echo=TRUE}

barraA=ggplot(Anolis, aes(SEX_AGE))
barraA+geom_bar(fill=grey(.3))+
  theme(axis.title=element_text(size=14,face="bold"))
```

En el segundo, el ancho de las barras fue reducido para que se vean menos angostas usando la opción **width**, ene ejemplo se reduce el ancho de las barras **width=.3**.  Además, se cambia la descripción de los ejes al castellano. También selecciono un otro color de gris y se modifico su intensidad con **fill=grey(.5)**.

```{r}
barraA=ggplot(Anolis, aes(SEX_AGE))
barraA+geom_bar(width=.3, fill=grey(.5))+
  labs(y="Frecuencia", x="Género y edad")+
  theme(axis.title=element_text(size=10,face="bold"))
```

En el tercer grafico las barras fueron rotadas usando la opción **coord_flip()** y puestas sobre lo que antes era el eje de **Y**.  En el cuarto, se añadió una variable discreta como color; en este caso, fue usada la escala de color gris para distinguir entre la temporada seca **dry**  la lluviosa **wet**. Si no se añade la opción scale_fill_grey(), las categorías tendrían color.

```{r geombar2a, echo=TRUE}

barraA=ggplot(Anolis, aes(SEX_AGE))
B3=barraA+geom_bar(fill=grey(.5))+coord_flip()+
  labs(y="Frecuencia", x="Género y edad")+
  theme(axis.title=element_text(size=10,face="bold"))

barraA=ggplot(Anolis, aes(SEX_AGE, fill=SEASON))
B4=barraA+geom_bar()+scale_fill_grey()+
  labs(y="Frecuencia", x="Género y edad")+
  theme(axis.title=element_text(size=10,face="bold"))

grid.arrange(B3,B4,ncol=1)
```

***
### Posiciones de las barras


   Si uno quiere posicionar las categorías una al lado de la otra, se usa **(position={dodge})**. El parámetro **dodge** le indica **esquivar** en el sentido de mover al lado. 

```{r geombar3,  echo=TRUE}

barraA=ggplot(Anolis, aes(SEX_AGE,fill=SEASON))
B1=barraA+geom_bar()+
  labs(y="Frecuencia", x="Género y edad")+
  theme(axis.title=element_text(size=10,face="bold"))

barraA=ggplot(Anolis, aes(SEX_AGE,fill=SEASON))
B2=barraA+geom_bar(position="dodge")+
  labs(y="Frecuencia", x="Género y edad")+
  theme(axis.title=element_text(size=10,face="bold"))

grid.arrange(B1,B2,ncol=1)
```

# Opciones y Parametros de **geom_bar**:


  * ggplot(el archivo de datos, aes(la variable continua))
  + geom_bar(stat=bin, x, y, alpha, color, fill, linetype, size)
    + alpha: la intensidad del color
    + fill: el color de la barra
    + color: el color de la línea alrededor de la barra
    + linetype: representa el estilo de línea
    + size: representa el grosor de la línea
    + weight; para modificar el valor original; entonces no sería, por ejemplo, el conteo/suma de los valores si no un valor ponderado (promedio ponderado).
